#!/usr/bin/env bash

set -euEo pipefail

# shellcheck source=../share/mediawiki-shell/common
source /usr/share/mediawiki-shell/common

log info "START"

# shellcheck disable=SC2317
exit_handler() {
  [[ -v retry_counter ]] || retry_counter=0
  if [ "$retry_counter" -gt 1 ]; then
    log notice "success after attempt $retry_counter"
  fi
}

trap exit_handler EXIT

do_it() {
  wiki_backup_file="${folder}/${file}"
  wiki_article_to_fetch="$page" \
    wiki_fetch_to_file="$wiki_backup_file" \
    WIKI_URL="$wiki" \
    mw-fetch

  ## {{{
  ## XXX

  ## TODO: Should probably be done in mw-patch-modify-wiki-page

  DESTINATION_WIKI_URL="$WIKI_URL"

  ## Remove trailing spaces.
  sed -i 's/[[:space:]]*$//' "$wiki_backup_file"

  #    if ! \
  #       WIKI_URL="$DESTINATION_WIKI_URL" \
  #       edit_message="remove-trailing-spaces" \
  #       mw-edit "$page" "$wiki_backup_file" ; then
  #          log error "mw-edit '$page' '$wiki_backup_file' failed!"
  #          return 1
  #    fi

  #   file_name="$wiki_backup_file"
  #
  #
  #   ## Ignore pages without header.
  #   if ! grep --ignore-case --fixed-strings --quiet -e "{{header" -- "$file_name"; then
  #     return 0
  #   fi
  #
  #   ## Ignore redirects.
  #   if grep --ignore-case --fixed-strings --quiet -e "#redirect [[" -- "$file_name"; then
  #     return 0
  #   fi
  #
  #   ## TODO: remove '!'
  #   ## Ignore pages without SEO.
  #   if ! grep --ignore-case --fixed-strings --quiet -e "{{#seo:" -- "$file_name"; then
  #     return 0
  #   fi
  #
  #   ## Ignore pages that already have a title.
  #   if grep --ignore-case --fixed-strings --quiet -e "{{title|" -- "$file_name"; then
  #     return 0
  #   fi
  #
  #   if grep --ignore-case --fixed-strings --quiet -e "title=" -- "$file_name"; then
  #     return 0
  #   fi
  #
  #   title="$page"
  #   title="$(echo "$title" | str_replace ".mw" "")"
  #   title="$(echo "$title" | str_replace "_" " ")"
  #
  #    search="{{#seo:"
  #    replace="\
  # {{title|title=
  # $title
  # }}
  # {{#seo:"
  #
  #    str_replace "$search" "$replace" "$wiki_backup_file"
  #
  #    if ! \
  #       WIKI_URL="$DESTINATION_WIKI_URL" \
  #       edit_message="add-title" \
  #       mw-edit "$page" "$wiki_backup_file" ; then
  #          log error "mw-edit '$page' '$wiki_backup_file' failed!"
  #          return 1
  #    fi

  ## }}}
}

usage(){
  printf '%s\n' "Usage: ${0##*/} WIKI FOLDER FILENAME PAGE
Example:
  ${0##*/} 'https://www.kicksecure.com/w'" >&2
  exit 1
}

if [[ -z "${4-}" || "${1-}" =~ (-h|--help) ]]; then
  usage
fi

wiki="$1"
folder="$2"
file="$3"
page="$4"

log info "folder: $folder"

mkdir -p -- "$folder"

if ! test -d "$folder"; then
  log error "folder '$folder' does not exist! Run...?:"
  echo "mkdir --parents -- '$folder'"
  exit 1
fi

if ! test -w "$folder"; then
  log error "folder '$folder' unwriteable! Run...?:"
  echo "chown --recursive -- '$USER:$USER' '$folder'"
  exit 1
fi

for retry_counter in {1..5}; do
  if do_it; then
    ## Success. Exit success.
    exit 0
  fi
  ## Failed. Wait and try again.
  sleep 5
done

## Failed even after retry attempts. Therefore exit non-zero.
exit 1
