#!/usr/bin/env bash

## Does not unduplicate. That should be done with a different script.

## example:
## See mw-wiki-to-weblinks.

set -euEo pipefail

## XXX
WIKI_URL=""

# shellcheck source=../share/mediawiki-shell/common
source /usr/share/mediawiki-shell/common
# shellcheck source=../share/mediawiki-shell/wiki-config
source /usr/share/mediawiki-shell/wiki-config

not_as_root

files_list+=("$wiki_folder"/*.mw)

total=0
for file_name in "${files_list[@]}"; do
  total=$((total + 1))
done

counter=0
for file_name in "${files_list[@]}"; do
  counter=$((counter + 1))
  base_name=$(basename "$file_name")
  without_file_extension=${base_name%.mw}
  log debug "## $counter / $total | file_name: '$base_name' | $WIKI_WEB/$without_file_extension"
  test -r "$file_name"

  web_links_list=$(mw-file-to-weblinks "$file_name")
  for web_link_item in $web_links_list; do
    web_link_cleaned=$(mw-wiki-link-clean "$web_link_item")
    if [ -z "$web_link_cleaned" ]; then
      continue
    fi
    ## Thanks to:
    ## Dennis Williamson
    ## https://stackoverflow.com/users/26428/dennis-williamson
    ## https://stackoverflow.com/a/3184819/2605155
    regex='^(https?)://[-[:alnum:]\+&@#/%?=~_|!:,.;]*[-[:alnum:]\+&@#/%=~_|]'
    string="$web_link_cleaned"
    if [[ $string =~ $regex ]]; then
      stprint "$web_link_cleaned"
    else
      stecho "## invalid link: $web_link_cleaned"
    fi
  done
done
