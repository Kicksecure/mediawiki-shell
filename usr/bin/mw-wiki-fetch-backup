#!/usr/bin/env bash

set -euEo pipefail

# shellcheck source=../share/mediawiki-shell/common
source /usr/share/mediawiki-shell/common

log info "START"

# shellcheck disable=SC2317
exit_handler() {
  [[ -v retry_counter ]] || retry_counter=0
  if [ "$retry_counter" -gt 1 ]; then
    log notice "success after attempt $retry_counter"
  fi
}

trap exit_handler EXIT

usage(){
  printf '%s\n' "Usage: ${0##*/} WIKI OUTPUT PAGE
Example:
  ${0##*/} 'https://www.kicksecure.com/w' /tmp/a Some_Article" >&2
  exit 1
}

if [[ -z "${3-}" || "${1-}" =~ (-h|--help) ]]; then
  usage
fi

wiki_url="$1"
output="$2"
page="$3"

output_dir="$(dirname "${output}")"
log info "output_dir: $output_dir"

mkdir -p -- "$output_dir"
if ! test -d "$output_dir"; then
  log error "output_dir '$output_dir' does not exist! Run?: mkdir --parents -- '$output_dir'"
  exit 1
fi

if ! test -w "$output_dir"; then
  log error "output_dir '$output_dir' unwriteable! Run?: chown --recursive -- '$USER:$USER' '$output_dir'"
  exit 1
fi

for retry_counter in {1..5}; do
  if mw-fetch "$wiki_url" "$page" "$output"; then
    exit 0
  fi
  sleep 5
done

exit 1
