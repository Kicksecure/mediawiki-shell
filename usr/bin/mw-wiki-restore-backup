#!/usr/bin/env bash

set -euEo pipefail

# shellcheck source=../share/mediawiki-shell/common
source /usr/share/mediawiki-shell/common

log info "START"

# TODO: ben: Unused function and variable. Confirm deletion.
error_out_maybe() {
  if [ "$wiki_error_on_fetch" = "true" ]; then
    ## error out
    return 1
  else
    ## ignore error
    return 0
  fi
}

usage(){
  printf '%s\n' "Usage: ${0##*/} WIKI DIR
Example:
  ${0##*/} 'https://www.kicksecure.com/w'
  ${0##*/} 'https://www.kicksecure.com/w' ~/mediawiki-shell/kicksecure-wiki-backup" >&2
  exit 1
}

if [[ -z "${2-}" || "${1-}" =~ (-h|--help) ]]; then
  usage
fi

wiki="$1"
folder="$2"

[[ -v wiki_error_on_fetch ]] || wiki_error_on_fetch=true

allpages_file="${TMPFOLDER}/allpages.txt"
safe-rm -f -- "$allpages_file"

log info "TMPFOLDER: $TMPFOLDER"
log info "folder   : $folder"
log info "wiki     : $wiki"

mkdir -p -- "$folder"

if ! test -d "$folder"; then
  log error "folder '$folder' does not exist! Run...?:"
  echo "mkdir --parents -- '$folder'"
  exit 1
fi

if ! test -w "$folder"; then
  log error "folder '$folder' unwriteable! Run...?:"
  echo "chown --recursive -- '$USER:$USER' '$folder'"
  exit 1
fi

mw-logout "$SOURCE_WIKI_URL"
mw-login "$SOURCE_WIKI_URL"
## TODO
die 1 "ERROR: UNFINISHED SCRIPT!"

## Remove trailing spaces.
# shellcheck disable=SC2001,SC2317
wiki_page_content="$(sed 's/[[:space:]]*$//' <<<"$wiki_page_content")"
