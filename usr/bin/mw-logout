#!/usr/bin/env bash
set -euEo pipefail

# shellcheck source=../share/mediawiki-shell/common
source /usr/share/mediawiki-shell/common

usage(){
  printf '%s\n' "Usage: ${0##*/} WIKI
Example:
  ${0##*/} 'https://www.kicksecure.com/w'" >&2
  exit 1
}

if [[ -z "${1-}" || "${1-}" =~ (-h|--help) ]]; then
  usage
fi

# shellcheck source=../share/mediawiki-shell/wiki-config
WIKI_URL="$1" source /usr/share/mediawiki-shell/wiki-config

log info "Logging out of $WIKI_API... Requesting CSRF token..."
safe-rm -f -- "${TMPFOLDER}/logout-token.json"

curl_run \
  "${curl_opts[@]}" \
  --cookie "$cookie_jar" \
  --cookie-jar "$cookie_jar" \
  --header "Content-Type: application/json" \
  --header "Accept-Language: en-GB" \
  --output "${TMPFOLDER}/logout-token.json" \
  --request "POST" \
  "${WIKI_API}?action=query&meta=tokens&type=csrf&format=json"
log info "Token received."
csrf_token="$(jq --raw-output '.query.tokens.csrftoken' -- "${TMPFOLDER}/logout-token.json")"

curl_run \
  "${curl_opts[@]}" \
  --cookie "$cookie_jar" \
  --cookie-jar "$cookie_jar" \
  --header "Accept-Language: en-GB" \
  --data-urlencode "token=${csrf_token}" \
  --output "${TMPFOLDER}/logout.json" \
  --request "POST" \
  "${WIKI_API}?action=logout&format=json"

if [ "$(stcat "${TMPFOLDER}/logout.json")" = "{}" ] ||
  [ "$(jq --raw-output '.warnings.logout."*"' -- "${TMPFOLDER}/logout.json")" = "You must be logged in." ]
then
  log info "OK, logged out."
  exit 0
fi

jq . -- "${TMPFOLDER}/logout.json" | stcat >&2
die 1 "Logout failed!"
