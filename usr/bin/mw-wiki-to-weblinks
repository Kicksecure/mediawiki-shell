#!/usr/bin/env bash

## Does not unduplicate. That should be done with a different script.

set -euEo pipefail

## XXX
WIKI_URL=""

# shellcheck source=../share/mediawiki-shell/common
source /usr/share/mediawiki-shell/common
# shellcheck source=../share/mediawiki-shell/wiki-config
source /usr/share/mediawiki-shell/wiki-config

not_as_root

mkdir -p -- "$TMPFOLDER/wiki-links"

## TODO: path
path=~/sourcesown/wiki-backup/
test -d "${path}kicksecure-wiki-backup"
test -d "${path}whonix-wiki-backup"

for dir in "${path}kicksecure-wiki-backup" "${path}whonix-wiki-backup"; do
  git -C "${dir}" config pull.ff only
  git -C "${dir}" pull
done

safe-rm -f -- "$TMPFOLDER/wiki-links/all-links.txt"

log info "Try: tail -f -- $TMPFOLDER/wiki-links/all-links.txt"

WIKI_WEB=https://www.kicksecure.com/wiki \
  wiki_folder=~/sourcesown/wiki-backup/kicksecure-wiki-backup \
  mw-folder-to-weblinks | tee -a "$TMPFOLDER/wiki-links/all-links.txt"

WIKI_WEB=https://www.kicksecure.com/wiki \
  wiki_folder=~/sourcesown/wiki-backup/whonix-wiki-backup \
  mw-folder-to-weblinks | tee -a "$TMPFOLDER/wiki-links/all-links.txt"

grep --invert-match -- "## " -- "$TMPFOLDER/wiki-links/all-links.txt" | tee -- "$TMPFOLDER/wiki-links/links-without-comments.txt" >/dev/null
sort --unique -- "$TMPFOLDER/wiki-links/links-without-comments.txt" | tee -- "$TMPFOLDER/wiki-links/links-sorted.txt" >/dev/null

log info "Try: cat -- $TMPFOLDER/wiki-links/links-sorted.txt"
