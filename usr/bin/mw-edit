#!/usr/bin/env bash

set -euEo pipefail

# shellcheck source=../share/mediawiki-shell/common
source /usr/share/mediawiki-shell/common

usage(){
  printf '%s\n' "Usage: ${0##*/} WIKI PAGE INPUT [EDIT_MSG]
Defaults:
  EDIT_MSG=${default_edit_msg}
Example:
  ${0##*/} 'https://www.kicksecure.com/w' Ubuntu_software /tmp/a" >&2
  exit 1
}

default_edit_msg="mediawiki-shell-bot-default-edit-message"
if [[ -z "${3-}" || "${1-}" =~ (-h|--help) ]]; then
  usage
fi

wiki_url="$1"
page_title="$3"
new_file="$3"
edit_msg="${4-"${default_edit_msg}"}"

# shellcheck source=../share/mediawiki-shell/wiki-config
WIKI_URL="$wiki_url" source /usr/share/mediawiki-shell/wiki-config

if [ ! -r "$new_file" ]; then
  log error "Local file '$new_file' does not exist or is not readable!"
  exit 2
fi

if [ ! -s "$new_file" ]; then
  log info "Local file '$new_file' was empty."
  exit 0
fi

log info "Editing page '${WIKI_URL}' | '${WIKI_API}' | '$page_title'..."
#log info "Fetching edit token..."

mw-login-test "$wiki_url"

curl_run \
  "${curl_opts[@]}" \
  --cookie "$cookie_jar" \
  --cookie-jar "$cookie_jar" \
  --header "Accept-Language: en-GB" \
  --header "Connection: keep-alive" \
  --compressed \
  --output "${TMPFOLDER}/fetch-edit-token.json" \
  --request "GET" \
  "${WIKI_API}?action=query&meta=tokens&format=json"

csrf_token=$(jq --raw-output '.query.tokens.csrftoken' "${TMPFOLDER}/fetch-edit-token.json")

if [ "${#csrf_token}" = 42 ]; then
  log info "Edit token for page OK."
else
  log error "Edit token for page not set."
  exit 1
fi

#log info "Editing '$page_title'..."

## XXX
## &tags=mediawiki-shell
## Need to create wiki tag mediawiki-shell here:
## https://www.whonix.org/wiki/Special:Tags

curl_run \
  "${curl_opts[@]}" \
  --cookie "$cookie_jar" \
  --cookie-jar "$cookie_jar" \
  --header "Accept-Language: en-GB" \
  --header "Connection: keep-alive" \
  --header "Expect:" \
  --data-urlencode "title=$page_title" \
  --data-urlencode "text@$new_file" \
  --data-urlencode "token=$csrf_token" \
  --output "${TMPFOLDER}/edit-result.json" \
  --request "POST" \
  "${WIKI_API}?action=edit&format=json&tags=mediawiki-shell&summary=${edit_msg}&bot"

log info "Network for edit page ok."

test -r "${TMPFOLDER}/edit-result.json"

edit_result_output="$(stcat "${TMPFOLDER}/edit-result.json")"

edit_result_jq="$(echo "$edit_result_output" | jq -r ".edit.result")"

if [ "$edit_result_jq" = "Success" ]; then
  exit 0
fi

jq . <<<"$edit_result_output" >&2
log error "Edit page error."

exit 1
