#!/usr/bin/env bash

set -euEo pipefail

# shellcheck source=../share/mediawiki-shell/common
source /usr/share/mediawiki-shell/common

usage(){
  printf '%s\n' "Usage: ${0##*/} [OPTIONS] WIKI SCRIPT [ARGS]
Options:
  --continue-from-page=N     Continue from page index.
Note:
  ARGS are passed to the SCRIPT.
Example:
  ${0##*/}" >&2
  exit 1
}

# shellcheck source=/usr/libexec/helper-scripts/parse_opt.sh
source /usr/libexec/helper-scripts/parse_opt.sh

continue_from_page=""

while true; do
  [[ "${1-}" =~ ^- ]] || break
  begin_optparse "${1:-}" "${2:-}" || break
  true "${opt-}" "${arg-}" "${opt_orig-}"
  case "${opt}" in
    continue-from-page) get_arg; continue_from_page="${arg}";;
    h|help) usage;;
    --|"") break;;
    *) die 2 "Invalid option: '${opt_orig}'"
  esac
  shift "${shift_n:-1}"
done

if [[ -z "${2-}" ]]; then
  usage
fi
wiki_url="$1"
wiki_script="$2"
shift 2

# shellcheck source=../share/mediawiki-shell/wiki-config
WIKI_URL="$wiki_url" source /usr/share/mediawiki-shell/wiki-config

log info "TMPFOLDER : $TMPFOLDER"
log info "WIKI_URL  : $WIKI_URL"

## Not required for public wiki.
#mw-login-test "$wiki_url"

allpages_file="${TMPFOLDER}/allpages.txt"

safe-rm -f -- "$allpages_file"
mw-all-pages "$wiki_url" allpages "$allpages_file"

test -r "$allpages_file"

counter_total="$(awk 'END {print NR}' "$allpages_file")"

counter_currently=0
counter_chunk=0
chunk_max_size=10
pid_list=""
start_from_here="not-yet"

while IFS=$'\n' read -r item_from_all_pages; do
  counter_currently=$((counter_currently + 1))
  backup_page_item=$(set_backup_page_item "$item_from_all_pages")
  backup_filename_item=$(set_backup_filename_item "$backup_page_item")

  ## XXX
  wiki_page_item="$backup_page_item"
  wiki_article_to_fetch="$backup_page_item"

  counter_chunk=$((counter_chunk + 1))

  ## TODO:
  #continue_from_page="Network_Time_Synchronization"

  if [ -z "$continue_from_page" ] ||[ "${backup_page_item,,}" = "${continue_from_page,,}" ]; then
    start_from_here=true
  fi

  if [ ! "$start_from_here" = "true" ]; then
    log info "skip: $counter_currently / $counter_total | counter_chunk: $counter_chunk | $backup_page_item | $backup_filename_item"
    continue
  fi
  log notice "act: $counter_currently / $counter_total | counter_chunk: $counter_chunk | $backup_page_item | $backup_filename_item"

  if [ "$backup_page_item" = "Changelog" ]; then
    continue
  fi

  TMPFOLDER_SEPARATE="$TMPFOLDER/separate/$counter_currently"
  mkdir --parents -- "$TMPFOLDER_SEPARATE"

  # TODO: ben: verify variables being passed
  run_background=1 log_run \
    env \
    counter_currently="$counter_currently" \
    counter_chunk="$counter_chunk" \
    TMPFOLDER="$TMPFOLDER_SEPARATE" \
    backup_page_item="$backup_page_item" \
    backup_filename_item="$backup_filename_item" \
    wiki_page_item="$wiki_page_item" \
    wiki_article_to_fetch="$wiki_article_to_fetch" \
    mw-retry-wrapper "$wiki_script" "$@"

  # The '$background_pid' is set by helper-scripts' log_run_die.sh.
  # shellcheck disable=SC2154
  pid_list+=" $background_pid"

  if [ "$counter_chunk" -ge "$chunk_max_size" ] || [ "$counter_currently" -ge "$counter_total" ]; then
    counter_chunk=0
    log info "wait $pid_list"

    for check_pid in $pid_list; do
      if ! wait "$check_pid"; then
        log error "check_pid '$check_pid' failed!"
      fi
    done

    pid_list=""
  fi

done <"$allpages_file"
